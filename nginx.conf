worker_processes  auto;


pid        /var/run/nginx.pid;


events {
    worker_connections  1024;
}
http {

    default_type  application/octet-stream;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for" '
                      'request_body:$request_body';



    lua_need_request_body on;

    server {
        listen 1819;

        location /v1/chat/completions {
            # 支持流式传输
            proxy_cache off;
            
            # 使用Lua脚本在请求阶段修改请求体
            access_by_lua_block {
                ngx.req.read_body()
                local data = ngx.req.get_body_data()
                if data then
                    -- 替换模型名
                    data = string.gsub(data, '"claude%-sonnet%-4%-20250514"', '"claude-sonnet-4"')
                    ngx.req.set_body_data(data)
                end
            }
            
            # 直接代理到目标API，保持流式传输
            proxy_pass https://api.deepbricks.ai/v1/chat/completions;
            proxy_set_header Host api.deepbricks.ai;
            proxy_set_header Content-Type "application/json";
            proxy_set_header Authorization $http_authorization;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            
            proxy_ssl_server_name on;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            
            # 流式传输关键配置
            proxy_read_timeout 300s;
            proxy_connect_timeout 300s;
            proxy_send_timeout 300s;
            
            # 禁用响应缓冲以支持流式传输
            proxy_buffering off;
            proxy_request_buffering off;
        }


    }
}